{% extends 'base.html' %}
{% load static %}
{% load product_filters %}

{% block title %}Sản Phẩm - Fitblog{% endblock %}

{% block content %}
<div class="products-container">
    <div class="products-banner">
        <div class="banner-content">
            <h1>Chào mừng đến với cửa hàng Fitblog</h1>
            <p>Whey Protein Chuẩn Dinh Dưỡng – Hỗ Trợ Phát Triển Cơ Bắp</p>
        </div>
    </div>

    <div class="products-grid-section">
        <div class="container">
            <div class="products-filters">
                <div class="filter-left">
                    <h3>Danh Mục</h3>
                    <div class="category-filters">
                        <a href="{% url 'products:product_list' %}" class="category-btn {% if not selected_category %}active{% endif %}">Tất cả</a>
                        {% for category in categories %}
                        <a href="?category={{ category.slug }}{% if sort_by %}&sort={{ sort_by }}{% endif %}" class="category-btn {% if selected_category == category.slug %}active{% endif %}">{{ category.name }}</a>
                        {% endfor %}
                    </div>
                </div>
                <div class="filter-right">
                    <label for="sort-select">Sắp xếp:</label>
                    <select id="sort-select" name="sort" class="sort-select" onchange="applySorting(this)">
                        <option value="-created_at" {% if sort_by == "-created_at" %}selected{% endif %}>Mới nhất</option>
                        <option value="price" {% if sort_by == "price" %}selected{% endif %}>Giá: Thấp đến Cao</option>
                        <option value="-price" {% if sort_by == "-price" %}selected{% endif %}>Giá: Cao đến Thấp</option>
                        <option value="-review_count" {% if sort_by == "-review_count" %}selected{% endif %}>Đánh giá cao nhất</option>
                    </select>
                </div>
            </div>

            <div class="products-list">
                {% include 'products/_product_list_partial.html' %}
            </div>

            {% include 'products/_pagination_partial.html' %}
        </div>
    </div>
</div>

<link rel="stylesheet" href="{% static 'css/products.css' %}">

<script>
function applySorting(selectElement) {
    const sortValue = selectElement.value;
    const currentUrl = new URL(window.location.href);
    
    // Preserve existing filters
    currentUrl.searchParams.set('sort', sortValue);
    currentUrl.searchParams.set('page', '1');
    
    // Show loading state
    const productsList = document.querySelector('.products-list');
    const originalContent = productsList.innerHTML;
    productsList.innerHTML = '<div class="text-center my-5"><div class="spinner-border" role="status"><span class="visually-hidden">Đang tải...</span></div></div>';
    
    // Fetch new products with AJAX
    fetch(currentUrl.toString(), {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Update products list
            document.querySelector('.products-list').innerHTML = data.products_html;
            
            // Update pagination
            const paginationNav = document.querySelector('.pagination-nav');
            if (paginationNav) {
                paginationNav.innerHTML = data.pagination_html;
            }
            
            // Update URL without reload
            window.history.pushState({}, '', currentUrl.toString());
            
            // Scroll to products smoothly
            document.querySelector('.products-list').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        } else {
            throw new Error('Response success is false');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Fallback: show original content and do normal navigation
        productsList.innerHTML = originalContent;
        window.location.href = currentUrl.toString();
    });
}

// Track product click event
function trackProductClick(event, productId) {
    // Send tracking event to backend
    fetch('{% url "products:track_product_click" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify({
            product_id: productId,
            event_type: 'click'
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Click tracked:', data);
    })
    .catch(error => {
        console.error('Tracking error:', error);
    });
    
    // Don't prevent default - allow normal navigation
}
</script>
{% endblock %}
