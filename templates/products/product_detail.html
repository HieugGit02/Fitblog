{% extends 'base.html' %}
{% load static %}
{% load product_filters %}

{% block title %}{{ product.name }} - Fitblog Shop{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/product_detail.css' %}">

<div class="container py-5 product-detail">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4" style="font-size: 0.9rem;">
        <a href="{% url 'products:product_list' %}?category={{ product.category.slug }}" style="color: var(--primary-green); text-decoration: none; font-weight: 600;">
            {{ product.category.name }}
        </a>
        <span style="color: #999; margin: 0 0.5rem;">‚Ä∫</span>
        <span style="color: #333;">{{ product.name }}</span>
    </nav>

    <!-- Product Detail Grid Layout -->
    <div class="product-detail-wrapper">
        <!-- LEFT: Product Image (Sticky) -->
        <div class="product-image-section">
            <div class="product-image-container">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% else %}
                    <div class="product-image-placeholder">
                        <p>Ch∆∞a c√≥ h√¨nh ·∫£nh s·∫£n ph·∫©m</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- RIGHT: Product Info -->
        <div class="product-info-section">
            <!-- Header -->
            <div class="product-header">
                <span class="product-category-badge">{{ product.category.name }}</span>
                <h1 class="product-title">{{ product.name }}</h1>
                <p class="product-subtitle">{{ product.supplement_type|upper }} - Ch·∫•t l∆∞·ª£ng cao</p>
            </div>

            <!-- Rating -->
            <div class="rating-section">
                <div class="rating-stars">
                    {% for i in rating_range %}
                        {% if i <= avg_rating %}‚òÖ{% else %}‚òÜ{% endif %}
                    {% endfor %}
                </div>
                <div class="rating-info">
                    <div class="rating-value">{% if avg_rating %}{{ avg_rating|floatformat:1 }}{% else %}0{% endif %}</div>
                    <div class="rating-count">({{ review_count }} ƒë√°nh gi√°)</div>
                </div>
            </div>

            <!-- Price Hero Section -->
            <div class="price-hero">
                <div class="price-hero-content">
                    <div class="price-label">Gi√° hi·ªán t·∫°i</div>
                    <div class="price-display">
                        <div class="current-price">{{ product.get_discounted_price|floatformat:0|format_price }}‚Ç´</div>
                        {% if product.discount_percent > 0 %}
                            <div class="original-price">{{ product.price|floatformat:0|format_price }}‚Ç´</div>
                        {% endif %}
                    </div>
                    {% if product.discount_percent > 0 %}
                        <span class="discount-badge">Gi·∫£m {{ product.discount_percent }}%</span>
                    {% endif %}
                </div>
            </div>

            <!-- Key Features -->
            <div class="key-features">
                <div class="feature-card">
                    <div class="feature-label">Kh·∫©u Ph·∫ßn</div>
                    <div class="feature-value">{{ product.serving_size }}</div>
                </div>
                <div class="feature-card">
                    <div class="feature-label">S·ªë L∆∞·ª£ng</div>
                    <div class="feature-value">{% if product.stock > 0 %} {{ product.stock }} {% else %}H·∫øt h√†ng{% endif %}</div>
                </div>
            </div>

            <!-- Action Buttons with Quantity -->
            <div class="action-buttons-section">
                <!-- Flavor Selection (n·∫øu c√≥) -->
                {% if product.flavors.all %}
                <div class="flavor-selector">
                    <label class="flavor-label">Ch·ªçn H∆∞∆°ng V·ªã:</label>
                    <div class="flavor-buttons">
                        {% for flavor_obj in product.flavors.all %}
                            <button 
                                class="flavor-btn {% if forloop.first %}active{% endif %}" 
                                data-flavor="{{ flavor_obj.flavor }}"
                                onclick="selectFlavor(this)"
                                {% if not flavor_obj.is_available %}disabled{% endif %}
                            >
                                {{ flavor_obj.flavor }}
                            </button>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="selected-flavor" value="">
                </div>
                {% endif %}
                
                <div class="quantity-selector">
                    <label class="quantity-label">S·ªë l∆∞·ª£ng:</label>
                    <div class="quantity-input">
                        <button class="qty-btn" onclick="decreaseQty()">‚àí</button>
                        <input type="number" id="quantity" class="qty-field" value="1" min="1">
                        <button class="qty-btn" onclick="increaseQty()">+</button>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-action btn-primary-action" onclick="addToCart()">
                        Th√™m Gi·ªè H√†ng
                    </button>
                    <button class="btn-action btn-secondary-action">
                        Th√™m Wishlist
                    </button>
                </div>
            </div>

            <!-- Description -->
            {% if product.description %}
            <div class="description-section">
                <h3>M√¥ T·∫£ S·∫£n Ph·∫©m</h3>
                <p>{{ product.description }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Nutrition Section -->
    {% if product.protein_per_serving or product.carbs_per_serving or product.fat_per_serving or product.calories_per_serving %}
    <div class="nutrition-section">
        <h2 class="section-title">Th√¥ng Tin Dinh D∆∞·ª°ng</h2>
        <div class="nutrition-grid">
            {% if product.protein_per_serving %}
            <div class="nutrition-item">
                <div class="nutrition-value">{{ product.protein_per_serving|floatformat:1 }}g</div>
                <div class="nutrition-label">Protein</div>
            </div>
            {% endif %}

            {% if product.carbs_per_serving %}
            <div class="nutrition-item">
                <div class="nutrition-value">{{ product.carbs_per_serving|floatformat:1 }}g</div>
                <div class="nutrition-label">Carbs</div>
            </div>
            {% endif %}

            {% if product.fat_per_serving %}
            <div class="nutrition-item">
                <div class="nutrition-value">{{ product.fat_per_serving|floatformat:1 }}g</div>
                <div class="nutrition-label">Fat</div>
            </div>
            {% endif %}

            {% if product.calories_per_serving %}
            <div class="nutrition-item">
                <div class="nutrition-value">{{ product.calories_per_serving|floatformat:0 }}</div>
                <div class="nutrition-label">Kcal</div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Tags & Goals -->
    {% if product.get_tags_list or product.get_goals_list %}
    <div class="tags-section">
        <h2 class="section-title">ƒê·∫∑c ƒêi·ªÉm</h2>
        <div class="tags-list">
            {% if product.get_tags_list %}
                {% for tag in product.get_tags_list %}
                    <span class="tag">{{ tag }}</span>
                {% endfor %}
            {% endif %}
            {% if product.get_goals_list %}
                {% for goal in product.get_goals_list %}
                    <span class="tag">{{ goal }}</span>
                {% endfor %}
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Ingredients -->
    {% if product.ingredients or product.flavor %}
    <div class="description-section">
        {% if product.flavor %}
            <h3>H∆∞∆°ng V·ªã</h3>
            <p>{{ product.flavor }}</p>
        {% endif %}
        {% if product.ingredients %}
            <h3>Th√†nh Ph·∫ßn</h3>
            <p>{{ product.ingredients }}</p>
        {% endif %}
    </div>
    {% endif %}

    <!-- Reviews Section -->
    <div class="reviews-container">
        <h2 class="section-title">ƒê√°nh Gi√° T·ª´ Kh√°ch H√†ng</h2>

        <!-- Success/Error Message -->
        {% if message %}
        <div class="alert {% if 'C·∫£m ∆°n' in message %}alert-success{% else %}alert-danger{% endif %}" role="alert">
            {{ message }}
        </div>
        {% endif %}

        {% if reviews %}
            {% for review in reviews %}
            <div class="review-item">
                <div class="review-header">
                    <div>
                        <div class="review-author">{{ review.author_name }}</div>
                        <div class="review-date">{{ review.created_at|date:"d/m/Y" }}</div>
                    </div>
                    <div class="review-rating">
                        {% for i in rating_range %}
                            {% if i <= review.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                        {% endfor %}
                        {{ review.rating }}/5
                    </div>
                </div>
                <div class="review-title">{{ review.title }}</div>
                <div class="review-content">{{ review.content }}</div>
                <div class="tags-list">
                    {% if review.is_verified_purchase %}
                        <span class="tag">X√°c minh mua h√†ng</span>
                    {% endif %}
                    <button class="helpful-btn" data-review-id="{{ review.id }}" onclick="markHelpful(this)">
                        üëç <span class="helpful-count">{{ review.helpful_count }}</span> ng∆∞·ªùi t√¨m h·ªØu √≠ch
                    </button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="description-section">
                <p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</p>
            </div>
        {% endif %}

        <!-- Review Form -->
        <div class="description-section" style="margin-top: 2rem;">
            <h3>ƒê·ªÉ L·∫°i ƒê√°nh Gi√°</h3>
            <form method="post" class="mt-3">
                {% csrf_token %}
                <div class="mb-3">
                    <label class="form-label">T√™n c·ªßa b·∫°n</label>
                    <input type="text" class="form-control" name="author_name" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" name="author_email" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">ƒê√°nh gi√°</label>
                    <select class="form-select" name="rating" required>
                        <option value="">-- Ch·ªçn --</option>
                        <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Tuy·ªát v·ªùi (5 sao)</option>
                        <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ R·∫•t t·ªët (4 sao)</option>
                        <option value="3">‚òÖ‚òÖ‚òÖ T·ªët (3 sao)</option>
                        <option value="2">‚òÖ‚òÖ B√¨nh th∆∞·ªùng (2 sao)</option>
                        <option value="1">‚òÖ Kh√¥ng t·ªët (1 sao)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Ti√™u ƒë·ªÅ</label>
                    <input type="text" class="form-control" name="title" placeholder="VD: Tuy·ªát v·ªùi!" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">N·ªôi dung</label>
                    <textarea class="form-control" name="content" rows="4" placeholder="Chia s·∫ª tr·∫£i nghi·ªám..." required></textarea>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="is_verified_purchase" id="verified">
                    <label class="form-check-label" for="verified">
                        T√¥i ƒë√£ mua s·∫£n ph·∫©m n√†y
                    </label>
                </div>

                <button type="submit" class="btn-action btn-primary-action">G·ª≠i ƒê√°nh Gi√°</button>
            </form>
        </div>

        <!-- Recommendations Section -->
        {% if recommendations %}
        <div class="recommendations-section" style="margin-top: 3rem;">
            <h2 class="section-title">S·∫£n Ph·∫©m T∆∞∆°ng T·ª±</h2>
            <div class="recommendations-grid">
                {% for rec in recommendations %}
                <a href="{% url 'products:product_detail' rec.slug %}" class="recommendation-card text-decoration-none">
                    <div class="rec-content">
                        <h6 class="rec-title">{{ rec.name }}</h6>
                        <div class="rec-rating">
                            {% if rec.avg_rating %}
                                {% for i in "12345" %}
                                    {% if i|add:"0" <= rec.avg_rating %}‚òÖ{% else %}‚òÜ{% endif %}
                                {% endfor %}
                                <small>({{ rec.review_count }})</small>
                            {% else %}
                                <span class="text-muted">Ch∆∞a c√≥ ƒë√°nh gi√°</span>
                            {% endif %}
                        </div>
                        <p class="rec-price">
                            <strong>{{ rec.get_discounted_price|floatformat:0|format_price }} ‚Ç´</strong>
                        </p>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Flavor selection handler
    function selectFlavor(button) {
        // Remove active class from all flavor buttons
        document.querySelectorAll('.flavor-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Add active class to clicked button
        button.classList.add('active');
        
        // Save selected flavor to hidden input
        const flavorValue = button.getAttribute('data-flavor');
        document.getElementById('selected-flavor').value = flavorValue;
        
        // Save to localStorage for persistence
        localStorage.setItem('selectedFlavor', flavorValue);
    }

    // Initialize flavor selection on page load
    document.addEventListener('DOMContentLoaded', function() {
        const flavorBtns = document.querySelectorAll('.flavor-btn');
        if (flavorBtns.length > 0) {
            // Check if there's a saved flavor in localStorage
            const savedFlavor = localStorage.getItem('selectedFlavor');
            
            // Select first button by default, or the saved one
            flavorBtns.forEach((btn, index) => {
                if (savedFlavor && btn.getAttribute('data-flavor') === savedFlavor) {
                    btn.classList.add('active');
                    document.getElementById('selected-flavor').value = savedFlavor;
                } else if (index === 0) {
                    btn.classList.add('active');
                    document.getElementById('selected-flavor').value = btn.getAttribute('data-flavor');
                }
            });
        }
    });

    function increaseQty() {
        const qty = document.getElementById('quantity');
        qty.value = parseInt(qty.value) + 1;
    }

    function decreaseQty() {
        const qty = document.getElementById('quantity');
        if (parseInt(qty.value) > 1) {
            qty.value = parseInt(qty.value) - 1;
        }
    }

    function addToCart() {
        const qty = document.getElementById('quantity').value;
        alert(`ƒê√£ th√™m ${qty} s·∫£n ph·∫©m v√†o gi·ªè h√†ng!`);
    }

    function markHelpful(btn) {
        const reviewId = btn.getAttribute('data-review-id');
        
        // Send POST request to API
        fetch(`/api/reviews/${reviewId}/mark_helpful/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update the count in UI
                btn.querySelector('.helpful-count').textContent = data.helpful_count;
                // Show success feedback
                btn.style.backgroundColor = '#A5D6A7';
                btn.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    btn.style.transform = 'scale(1)';
                }, 200);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Track this product view
    document.addEventListener('DOMContentLoaded', function() {
        const productId = {{ product.id }};
        fetch('{% url "products:track_product_click" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({
                product_id: productId,
                event_type: 'click'
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Product view tracked:', data);
        })
        .catch(error => {
            console.error('Tracking error:', error);
        });
    });
</script>
{% endblock %}